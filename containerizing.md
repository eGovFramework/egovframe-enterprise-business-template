# Containerizing

## App ë¹Œë“œ
```shell
docker build -t egov-ebt:4.3.0 .
```

* ARM ê¸°ë°˜(ì˜ˆ: Apple Silicon)ì—ì„œ ë¹Œë“œí•  ë•ŒëŠ” ë©€í‹° í”Œë«í¼ì„ ì§€ì›í•˜ë„ë¡ buildxë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
```shell
docker buildx build \
--platform linux/amd64,linux/arm64 \
-t egov-ebt:4.3.0 .
```

### [ì°¸ê³ ] Dockerë¡œ ë‹¨ë… ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
```shell
docker run -p 8080:8080 egov-ebt:4.3.0
```

## docker-composeì—ì„œ ì„œë¹„ìŠ¤ ì‹¤í–‰
```shell
# Database(mysql)ë§Œ ë¨¼ì € ì‹¤í–‰ (DB ì´ˆê¸°í™” ì¤€ë¹„)
docker-compose up -d mysql-db

# App ì‹¤í–‰ (depends_onìœ¼ë¡œ DB healthy ìƒíƒœ ëŒ€ê¸°)
docker-compose up -d app

# ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ í•œ ë²ˆì— ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ ì¶”ì²œ)
docker-compose up -d
```

## [ì£¼ì˜] ìµœì´ˆ ì‹¤í–‰ ì‹œ DB ì´ˆê¸°í™” ì„¸íŒ…
- docker-compose.ymlì— SQL íŒŒì¼ volumesê°€ ì—†ìœ¼ë¯€ë¡œ ìë™ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. DB ì»¨í…Œì´ë„ˆë¥¼ ë¨¼ì € ì‹¤í–‰í•œ í›„ DDL/DMLì„ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.
- ì¶”ì²œ ë°©ë²•: í˜¸ìŠ¤íŠ¸ì— `execute_sql.sh` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤€ë¹„í•˜ê³ , ì•„ë˜ ëª…ë ¹ì–´ë¡œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰.
  ```shell
  docker exec -it mysql-db bash -c "mysql -u root -padmin ebt < /path/to/all_ebt_ddl_mysql.sql"
  docker exec -it mysql-db bash -c "mysql -u root -padmin ebt < /path/to/all_ebt_data_mysql.sql"
  ```
  - `/path/to/`ëŠ” í˜¸ìŠ¤íŠ¸ ê²½ë¡œë¥¼ volumesë¡œ ë§ˆìš´íŠ¸í•œ ê²½ìš° ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê²½ë¡œë¡œ ëŒ€ì²´í•˜ì„¸ìš”.
- healthcheckê°€ 'SELECT 1'ì„ í™•ì¸í•˜ë¯€ë¡œ, ì´ˆê¸°í™” í›„ í…Œì´ë¸” ì¡´ì¬ë¥¼ ê²€ì¦í•˜ì„¸ìš”.

## ë³¼ë¥¨ ì œê±° (ì´ˆê¸°í™”)
```shell
docker-compose down -v
```
- ì´ ëª…ë ¹ìœ¼ë¡œ mysql-data ë³¼ë¥¨ì„ ì‚­ì œí•˜ì—¬ DBë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. ì¬ì‹œì‘ ì „ì— ì‚¬ìš©í•˜ì„¸ìš”.

### [ì°¸ê³ ] JVM ë©”ëª¨ë¦¬ ë° ì„±ëŠ¥ ì˜µì…˜ ì„¤ëª… ğŸ“Š

ì´ ë¬¸ì„œëŠ” Dockerfileì˜ `ENV JAVA_TOOL_OPTIONS`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Docker ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œ ìœ ìš©í•œ JVM ì˜µì…˜ì„ ìš”ì•½í•©ë‹ˆë‹¤. ê° ì˜µì…˜ì€ ë©”ëª¨ë¦¬ ê´€ë¦¬, GC ìµœì í™”, ë””ë²„ê¹…ì„ ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

### 1. ë©”ëª¨ë¦¬ ë¹„ìœ¨ ì„¤ì •
- **`-XX:MaxRAMPercentage=60.0`**  
  JVMì´ ì»¨í…Œì´ë„ˆì— í• ë‹¹ëœ ì „ì²´ ë©”ëª¨ë¦¬ì˜ 60%ë¥¼ ìµœëŒ€ í™ í¬ê¸°ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. (Java 8u191+ ì§€ì›)  
  ğŸ”¹ *ì¥ì *: ë™ì  ë©”ëª¨ë¦¬ ì¡°ì •ìœ¼ë¡œ OutOfMemoryError(OOM) ë°©ì§€.

### 2. ê°€ë¹„ì§€ ì»¬ë ‰í„°(GC)
- **`-XX:+UseG1GC`**  
  G1 GCë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (Java 8+ ì¶”ì²œ, ì €ì§€ì—° ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì í•©)  
  ğŸ”¹ *ì¥ì *: ëŒ€í˜• í™ì—ì„œ íš¨ìœ¨ì ì´ë©°, ì• í”Œë¦¬ì¼€ì´ì…˜ ì§€ì—° ìµœì†Œí™”.

### 3. ë©”ëª¨ë¦¬ ë¶€ì¡± ëŒ€ì‘
- **`-XX:+HeapDumpOnOutOfMemoryError`**  
  OOM ë°œìƒ ì‹œ í™ ë¤í”„ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤. (ë””ë²„ê¹… ìœ ìš©)  
  ğŸ”¹ *ì¥ì *: ë¬¸ì œ ë°œìƒ ì‹œ ë©”ëª¨ë¦¬ ìƒíƒœ ë¶„ì„ì— í™œìš©.

### 4. ë³´ì•ˆ ë° ëœë¤ ì†ŒìŠ¤ ìµœì í™”
- **`-Djava.security.egd=file:/dev/./urandom`**  
  SecureRandom ìƒì„± ì§€ì—°ì„ ë°©ì§€í•©ë‹ˆë‹¤. (ëœë¤ ì†ŒìŠ¤ë¥¼ /dev/urandomìœ¼ë¡œ ë³€ê²½)  
  ğŸ”¹ *ì¥ì *: ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œ ì•”í˜¸í™” ì‘ì—… ì†ë„ í–¥ìƒ.

### ì¶”ê°€ íŒ ğŸ’¡
- **ì ìš© ë°©ë²•**: Dockerfileì—ì„œ ì´ë¯¸ ì„¤ì •ëœ ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.  
  ì˜ˆ:
  ```dockerfile
  ENV JAVA_TOOL_OPTIONS="\
    -XX:MaxRAMPercentage=60.0 \
    -XX:+UseG1GC \
    -XX:+HeapDumpOnOutOfMemoryError \
    -Djava.security.egd=file:/dev/./urandom"
  ```
- **ì£¼ì˜**: Java ë²„ì „(Tomcat 9.0-jre8 ê¸°ë°˜)ê³¼ ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì œí•œì— ë”°ë¼ ì¡°ì •í•˜ì„¸ìš”. OOM ì‹œ í¼ì„¼íŠ¸ ê°’ì„ 70-80%ë¡œ ë†’ì—¬ë³´ì„¸ìš”.
- **ì°¸ê³ **: eGovFrameë‚˜ Spring Boot ì•±ì— ì í•©í•˜ë©°, Kubernetes í™˜ê²½ì—ì„œ ë¦¬ì†ŒìŠ¤ ìš”ì²­/ì œí•œê³¼ í•¨ê»˜ ì‚¬ìš©í•˜ë©´ íš¨ê³¼ì ì…ë‹ˆë‹¤. ë¡œê·¸ í™•ì¸: `docker logs egov-ebt`.

ì´ ìˆ˜ì • ë²„ì „ì€ ì›ë³¸ docker-compose.ymlê³¼ Dockerfileê³¼ ë” ì˜ ë§ìœ¼ë©°, ì´ì „ ëŒ€í™”(ì˜ˆ: SQL ìˆ˜ë™ ì‹¤í–‰)ë¥¼ ë°˜ì˜í–ˆìŠµë‹ˆë‹¤. ì¶”ê°€ ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ ì•Œë ¤ì£¼ì„¸ìš”!